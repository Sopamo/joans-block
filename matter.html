<!doctype html>
<html>

<head>
    <script src="./matter.min.js"></script>
</head>

<body>
    <script>
        // Matter.js
        // module aliases
        var Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Composite = Matter.Composite;

        // create an engine
        var engine = Engine.create({
            enableSleeping: true,
        });

        // create a renderer
        var render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                wireframes: false,
            },
        });

        const grid = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 
            1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 
            1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1,1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 
            0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 
        ]
        const columns = 90
        const size = 10
        const groundObjects = []
        for(let i = 0;i<grid.length;i++) {
            if(!grid[i]) {
                continue
            }
            const row = Math.floor(i / columns)
            const column = i % columns
            const block = Bodies.rectangle(column * size + size / 2, row * size + size / 2, size, size, { isStatic: false, friction: 0, staticFriction: 0})
            const constraint = Matter.Constraint.create({
                bodyA: block,
                pointB: {
                    x: block.position.x,
                    y: block.position.y,
                },
                stiffness: 0.1,
                render: {
                    visible: false,
                },
            })
            Composite.add(engine.world, [block, constraint])
        }

        const player = Bodies.rectangle(100, 100, 15, 15, {
            frictionAir: 0.06, 
            friction: 0.005,
            staticFriction: 0.01,
            render: {
                sprite: {
                    texture: './player.png'
                }
            }
        })
        Composite.add(engine.world, player)

        const movementForce = 0.0015
        const jumpForce = -0.005
        let jumpPreload = 1
        jumpState = 0 // 0 === not jumping, 2 === still squished sideways, 1 === squished lengthwise
        const jumpSizeChangeSpeed = 0.018
        Matter.Events.on(engine, "beforeUpdate", () => {
            // player.render.sprite.yScale = 1 / jumpPreload
            // player.render.sprite.yOffset = 1/jumpPreload * 0.5
            // player.render.sprite.xScale = jumpPreload
            if(jumpState === 2) {
                jumpPreload = Math.max(0.6, jumpPreload - jumpSizeChangeSpeed)
            }
            if(jumpPreload <= 0.6) {
                jumpState = 1
            }
            if(jumpState === 1) {
                jumpPreload = Math.min(1, jumpPreload + jumpSizeChangeSpeed)
                if(jumpPreload === 1) {
                    jumpState = 0
                }
            }
            if(pressedKeys[37]) {
                // left
                Matter.Body.applyForce(player, player.position, {
                    x: -1 * movementForce * player.mass,
                    y: 0,
                })
            }
            if(pressedKeys[39]) {
                // right
                Matter.Body.applyForce(player, player.position, {
                    x: movementForce * player.mass,
                    y: 0,
                })
            }
        })
        const pressedKeys = {}
        window.addEventListener("keydown", (e) => {
            console.log(e.keyCode)
            if(e.keyCode === 13) {
                const test = engine.world.bodies[100]
                Matter.Body.applyForce(test, test.position, {
                        // x: collision.penetration.x * blastForce * object.mass,
                        // y: collision.penetration.y * blastForce * object.mass,
                        x: 0,
                        y: -0.01,
                    })
            }
            pressedKeys[e.keyCode] = true
            if(e.keyCode === 38) {
                // up
                jumpPreload = Math.min(2, jumpPreload + 0.1)
            }
            if(e.keyCode === 32) {
                // Space
                const grenade = Bodies.circle(player.position.x, player.position.y - 15, 4, {
                    label: 'grenade',
                })
                Matter.Body.applyForce(grenade, grenade.position, {
                    x: 0.02 * grenade.mass,
                    y: -0.02 * grenade.mass,
                })
                Composite.add(engine.world, grenade)
            }
        })
        window.addEventListener("keyup", (e) => {
            pressedKeys[e.keyCode] = false
            if(e.keyCode === 38) {
                // up
                jumpState = 2
                Matter.Body.applyForce(player, player.position, {
                    x: 0,
                    y: Math.exp(jumpPreload) * jumpForce * player.mass,
                })
                jumpPreload = 1
            }
        })

        let forcesToApply = []

        Matter.Events.on(engine, 'beforeUpdate', function() {
            forcesToApply.forEach(entry => {
                Matter.Body.applyForce(entry.object, entry.position, entry.force)
            })
            forcesToApply = []
        })

        Matter.Events.on(engine, 'collisionStart', function(event) {
            event.pairs.forEach(pair => {
                if(pair.bodyB.label === 'grenade' || pair.bodyA.label === 'grenade') {
                    Matter.Composite.remove(engine.world, pair.bodyA)
                    Matter.Composite.remove(engine.world, pair.bodyB)
                    const grenade = pair.bodyB.label === 'grenade' ? pair.bodyB : pair.bodyA
                    if(grenade.triggered) {
                        return
                    }
                    grenade.triggered = true
                    const blastRadius = 30
                    const blastForce = 0.002
                    const blastArea = Matter.Bodies.circle(grenade.position.x, grenade.position.y, blastRadius, {
                        label: 'blastArea'
                    })
                    const collisions = Matter.Query.collides(blastArea, engine.world.bodies)
                    collisions.forEach(collision => {
                        const object = collision.bodyA.label === 'blastArea' ? collision.bodyB : collision.bodyA
                        forcesToApply.push({
                            object: object,
                            position: object.position,
                            force: {
                                x: collision.penetration.x * blastForce * object.mass,
                                y: collision.penetration.y * blastForce * object.mass,
                            }
                        })
                    })
                }
            })
        });

        // run the renderer
        Render.run(render);

        // create runner
        var runner = Runner.create();

        // run the engine
        Runner.run(runner, engine);
    </script>
</body>

</html>